# 概述
## 基本[[思想]] 
虽然不同的实现与特性让这基本概念变得有点复杂，但这个基本思想是所有**JS模块系统**的基础：[[逻辑]]分块，各自封装，相互独立。每个块自己决定暴露什么，引入什么。
## 意义
1. 是管理复杂性的永恒工具。
2. 开发者可通过它创建逻辑独立的代码。通过声明依赖将代码连接在一起。
3. 经证明，可优雅扩展到任何复杂度且跨平台的方案。
![[模块系统.svg]]

# 模块系统
1. 依赖关系建立方式
	1. 在模块开始列出所有依赖
	2. 允许动态添加依赖
# 模块标识符
意义：是模块系统通用的概念
作用：模块系统**本质**上是**键/值实体**，其中*每个模块都有个用于引用它的标识符*。
实现：
	1. 实例：在*模拟*模块的系统中可能是字符串，在*原生*实现的模块系统中可能是模块文件的实际路径
	2. 定义方式：有的模块系统可显式声明模块的标识符，有的会隐式使用文件名
	3. 完善的模块系统
		1. 不存在标识符冲突
		2. 任何模块都能无歧义地引用其他模块
原理
	1. 模块系统对*模块标识符*的实现，决定了将*模块标识符解析为实际模块*的过程[^1]。

# 模块依赖
模块系统的**核心**是模块的**依赖管理**。

指定*依赖*的模块与周围的环境会达成一种**契约**。

本地模块向模块系统声明一组外部模块（依赖），这些外部模块对于当前模块的正常运行是必须的。
	1. 模块系统会检测这些外部模块，保证能够被加载、在*本地模块运行时初始化所有依赖*
	2. 每个模块与唯一的模块标识符关联。
# 模块加载
加载：下载、执行
1. 当一个外部模块被指定为依赖时，本地模块期望在*执行它时，依赖已准备好并已初始化*。
2. 步骤[^3] 
	1. 浏览器中：浏览器收到模块代码→递归加载该模块所有依赖→所有依赖模块（整个依赖图）加载完毕→**执行**入口模块。
3. 方式：因为是==立即执行==，且模块的实现是包含将被立即执行的JS代码的文件。所以一种可能的加载方式是按照依赖图依次请求各个脚本。
4. 特点
	1. [[阻塞]]。前面的操作完成后才能执行后面的操作。但按顺序加载多个JS文件并不理想，且手动管理时较为麻烦

可以理解，因为要避免入口模块执行时出错，所以必须加载完整个依赖图再执行入口模块。
# 入口
1. 相互依赖的模块必须指定一个模块作为入口，也是代码的*执行起点*[^4]。
	1. 因为JS是*顺序执行、单线程*，所以所有代码必须有执行起点。
2. 入口模块可能依赖其他模块，其他模块可能再依赖其他模块，所以模块化JS应用的所有模块会构成依赖图
# 异步依赖
1. 因为JS可异步执行，所以模块可按需加载更好
	1. *让JS通知模块系统*在必要时加载模块，并在模块加载完毕时提供回调。
2. 优点
	1. 利用立即执行、可[[异步JS|异步]]的特点，让依赖的模块按需加载[^5]。当前模块则可通过使用script标签来动态加载，执行时会*异步加载*当前模块的依赖。这样不会生成依赖列表。
# 动态依赖
1. 有些模块系统要求在开始时列出所有依赖，有些模块系统允许在*运行时动态添加*依赖
	1. 动态添加的依赖：必须在模块执行前加载完毕。不同于常规模块
	2. 能实现更复杂的依赖关系，却增加了对模块静态分析的难度
# 静态分析
模块系统、分析工具、模块打包系统。
模块包含的JS代码会被静态分析，分析工具检查代码结构，在不运行的情况下推断行为。
对静态分析友好的模块系统可让模块打包系统更容易将代码处理为较少的文件
1. 浏览器收到JS代码，会使用分析工具在不执行代码的情况下检查*代码结构*推断行为[^6]。
2. 静态分析友好的模块系统能让模块打包系统更容易地将模块整理为较少的文件。
# 循环依赖
1. 要建立一个没有循环依赖的JS应用程序几乎不可能。所以所有[[JS模块化||模块系统]][^7]都支持循环依赖。
	1. 一个带有循环依赖的JS应用程序中，模块*加载顺序*可能出人意料。（只要*恰当封装*，使模块没有副作用，加载顺序就一般不影响应用程序的运行）
# 总结
组成
	1. 模块系统
	2. 模块标识符
	3. 模块依赖
	4. 入口
	5. 模块加载
	6. 动态加载
	7. 异步加载
	8. 静态分析
模块系统的行为
	1. 依赖
		1. 加载
		2. 初始化
		3. 异步：需要使用时才加载模块
		4. 动态：满足某个代码设定的条件时才加载模块
		5. 循环
	2. 加载
		1. 动态
		2. 异步/按需
	3. 执行
		1. 前：所有依赖已经被*准备*好，并已*初始化*。

[^1]: import \* as styled from './index.module.less'
[^2]: 没看懂
[^3]: 浏览器加载模块需要执行其中代码，但在执行之前需要确认该模块的所有依赖模块已加载完毕。
[^4]: JS是顺序执行，且单线程，所以必须有执行起点
[^5]: 执行到这个模块时，自动调用里面的函数
[^6]: 动态依赖无疑会为静态分析带来困难。导致模块依赖加载不完全，执行时报错？
[^7]: CommonJS，AMD，ES6